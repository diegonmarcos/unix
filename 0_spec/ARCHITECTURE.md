# Kinoite Bifrost

> **A RAM-optimized dual-profile security OS based on Fedora Kinoite**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚    â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                      â”‚
â”‚    â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•                      â”‚
â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                        â”‚
â”‚    â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•                        â”‚
â”‚    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                      â”‚
â”‚    â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•                      â”‚
â”‚                                                                             â”‚
â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                   â”‚
â”‚    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•                   â”‚
â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘                      â”‚
â”‚    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘                      â”‚
â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘                      â”‚
â”‚    â•šâ•â•â•â•â•â• â•šâ•â•â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•   â•šâ•â•                      â”‚
â”‚                                                                             â”‚
â”‚                    ANON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH                             â”‚
â”‚                           (the bridge)                                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **Device**: Surface Pro 8 (8GB RAM, 256GB NVMe)
> **Base**: Fedora Kinoite 41 (Immutable, atomic updates)
> **Goal**: QubesOS-style profile isolation with full RAM per session

---

## What is Kinoite Bifrost?

**Bifrost** is a custom Fedora Kinoite distribution that provides **QubesOS-level profile isolation** without the RAM overhead of running separate kernel instances.

### The Problem with QubesOS on 8GB RAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     QUBES OS RAM USAGE (8GB total)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  dom0 (admin VM)           ~1.5 GB                   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  sys-net (network)         ~400 MB                   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  sys-firewall              ~400 MB                   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  ANON qube                 ~2.0 GB                   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  AUTH qube                 ~2.0 GB                   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Overhead (Xen, buffers)   ~1.5 GB                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚                                                   ~7.8 GB                   â”‚
â”‚                                                                             â”‚
â”‚   RAM per profile: ~2 GB (unusable for real work!)                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### The Bifrost Solution

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   KINOITE BIFROST RAM USAGE (8GB total)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚                    ANON   or   AUTH                                 â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚                      FULL 8 GB RAM                                  â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚                   (one profile at a time)                           â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   RAM per profile: 8 GB (full system resources!)                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Isolation Spectrum: Where Bifrost Sits

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ISOLATION vs RAM TRADE-OFF                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  SECURITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚
â”‚  WEAKER                                                          STRONGER   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  User    â”‚  â”‚Namespace â”‚  â”‚ BIFROST  â”‚  â”‚ QubesOS  â”‚  â”‚ Air Gap  â”‚     â”‚
â”‚  â”‚ Accounts â”‚  â”‚ (Podman) â”‚  â”‚(BTRFS+   â”‚  â”‚ (Xen VMs)â”‚  â”‚ (2 PCs)  â”‚     â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚  LUKS)   â”‚  â”‚          â”‚  â”‚          â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ Same /etcâ”‚  â”‚ Shared   â”‚  â”‚ Separate â”‚  â”‚ Separate â”‚  â”‚ Separate â”‚     â”‚
â”‚  â”‚ Same /varâ”‚  â”‚ kernel   â”‚  â”‚ /etc,/varâ”‚  â”‚ kernels  â”‚  â”‚ hardware â”‚     â”‚
â”‚  â”‚ Shared   â”‚  â”‚ Shared   â”‚  â”‚ Shared   â”‚  â”‚ Split    â”‚  â”‚ Full     â”‚     â”‚
â”‚  â”‚ RAM      â”‚  â”‚ RAM      â”‚  â”‚ kernel   â”‚  â”‚ RAM      â”‚  â”‚ RAM each â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                   â–²                                        â”‚
â”‚                                   â”‚                                        â”‚
â”‚                              YOU ARE HERE                                  â”‚
â”‚                                                                             â”‚
â”‚  RAM per      8 GB          8 GB          8 GB          ~2 GB       8 GB   â”‚
â”‚  profile:   (shared)      (shared)      (shared)      (split)    (each PC) â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### The Fundamental Trade-off

| Approach | Kernel Isolation | Full RAM per Profile | Concurrent Profiles |
|----------|------------------|----------------------|---------------------|
| **Bifrost** | No (shared) | **Yes (8 GB)** | No (one at a time) |
| **QubesOS** | Yes (Xen) | No (~2 GB each) | Yes |
| **Dual-boot (2 OS)** | Yes | **Yes (8 GB)** | No |
| **16GB+ RAM** | Yes (Xen) | Yes (~8 GB each) | Yes |

### Key Insight

> **Shared kernel is the ONLY way to get full RAM per profile on limited hardware.**

Without kernel isolation (Xen, KVM), profiles share:
- The same Linux kernel in memory (~200 MB, not duplicated)
- The same system libraries in RAM (shared via CoW)
- **Result: Full 8 GB available to whichever profile is active**

With kernel isolation (QubesOS, Kata):
- Each VM loads its own kernel (~200 MB Ã— N)
- Each VM has dedicated RAM allocation
- Xen hypervisor overhead (~500 MB+)
- **Result: RAM split between VMs, each gets ~2-3 GB**

---

## What Bifrost Provides

| Feature | Method | Benefit |
|---------|--------|---------|
| **Profile isolation** | BTRFS subvolumes | Separate filesystems per profile |
| **Config separation** | @etc-anon, @etc-auth | Different hostname, SSH keys, network |
| **State separation** | @var-anon, @var-auth | Different logs, containers, cache |
| **Crypto hiding** | Nested LUKS | AUTH data invisible to ANON |
| **Full RAM** | Shared kernel | 8 GB per active profile |
| **Atomic updates** | rpm-ostree | Immutable /usr, rollback support |
| **Container isolation** | Podman rootless | Additional app-level isolation |

### Bifrost = QubesOS Model - Kernel Overhead

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   QubesOS isolation model                                                   â”‚
â”‚           +                                                                 â”‚
â”‚   Single-kernel efficiency (like standard Linux)                           â”‚
â”‚           +                                                                 â”‚
â”‚   Only 2 profiles (not N qubes)                                            â”‚
â”‚           =                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚               KINOITE BIFROST                                       â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚       QubesOS-style isolation optimized for 8 GB RAM                â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Comparison: Bifrost vs Alternatives

| Aspect | Bifrost | QubesOS | Dual-boot | Podman-only |
|--------|---------|---------|-----------|-------------|
| RAM per profile | **8 GB** | ~2 GB | **8 GB** | 8 GB (shared) |
| Install effort | 4 scripts | 1 ISO | Install twice | Minimal |
| Maintenance | Custom | Automatic | 2Ã— updates | Minimal |
| /etc isolation | **Yes** | Yes | Yes | No |
| /var isolation | **Yes** | Yes | Yes | No |
| Kernel isolation | No | **Yes** | Yes | No |
| Profile switching | Reboot | Window switch | Reboot | - |
| Surface Pro support | **Custom kernel** | Limited | Manual | N/A |
| Immutable OS | **Yes (ostree)** | Yes (templates) | No | No |

---

## When to Use What

| Your Situation | Recommendation |
|----------------|----------------|
| 8 GB RAM, need full resources per profile | **Bifrost** |
| 16 GB+ RAM, need concurrent profiles | QubesOS |
| Simple isolation, no special requirements | Dual-boot |
| Just want container isolation | Podman + Firejail |
| Maximum paranoia, budget available | 2 separate devices |

---

## Target Hardware

| Component | Specification | Notes |
|-----------|--------------|-------|
| Device | Surface Pro 8 | linux-surface kernel required |
| RAM | 8 GB | Optimized for limited RAM |
| Storage | 256 GB NVMe | LUKS + BTRFS subvolumes |
| Secure Boot | **Disabled** | Required for linux-surface |

---

## Surface Pro 8 Linux Support

### linux-surface Repository

Surface Pro 8 requires the **linux-surface** kernel and drivers for full hardware support.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SURFACE PRO 8 HARDWARE SUPPORT                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Component       â”‚     Status       â”‚            Notes                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Touchscreen          â”‚ âœ“ Works          â”‚ linux-surface kernel              â”‚
â”‚ Pen/Stylus           â”‚ âœ“ Works          â”‚ iptsd daemon required             â”‚
â”‚ Type Cover Keyboard  â”‚ âœ“ Works          â”‚ linux-surface kernel              â”‚
â”‚ Type Cover Trackpad  â”‚ âœ“ Works          â”‚ libwacom for gestures             â”‚
â”‚ WiFi (Intel AX201)   â”‚ âœ“ Works          â”‚ Stock kernel OK                   â”‚
â”‚ Bluetooth            â”‚ âœ“ Works          â”‚ Stock kernel OK                   â”‚
â”‚ Audio (speakers)     â”‚ âœ“ Works          â”‚ linux-surface kernel              â”‚
â”‚ Cameras (front/rear) â”‚ âœ— Limited        â”‚ IPU6 driver issues - use Windows  â”‚
â”‚ Windows Hello IR     â”‚ âœ— No support     â”‚ Use Windows for facial auth       â”‚
â”‚ Battery              â”‚ âœ“ Works          â”‚ surface_aggregator module         â”‚
â”‚ Power button         â”‚ âœ“ Works          â”‚ linux-surface kernel              â”‚
â”‚ Hibernate            â”‚ âš  Partial        â”‚ May need kernel params            â”‚
â”‚ Secure Boot          â”‚ âœ— Disabled       â”‚ Required for linux-surface        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Installation (Fedora Kinoite)

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Add linux-surface repository
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
sudo wget -O /etc/yum.repos.d/linux-surface.repo \
  https://pkg.surfacelinux.com/fedora/linux-surface.repo

# Import signing key
sudo rpm --import https://pkg.surfacelinux.com/keys/surface.asc

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Install Surface kernel and tools
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
rpm-ostree install \
  kernel-surface \
  kernel-surface-devel \
  iptsd \
  libwacom-surface \
  surface-control

# Reboot to new kernel
systemctl reboot

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Enable touchscreen/pen daemon
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
sudo systemctl enable --now iptsd
```

### Installation (Arch Linux - @light)

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Add linux-surface repository to pacman.conf
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
cat >> /etc/pacman.conf << 'EOF'

[linux-surface]
Server = https://pkg.surfacelinux.com/arch/
EOF

# Import signing key
curl -s https://pkg.surfacelinux.com/keys/surface.asc | sudo pacman-key --add -
sudo pacman-key --lsign-key 56C464BAAC421453

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Install Surface packages
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
sudo pacman -Syu
sudo pacman -S linux-surface linux-surface-headers iptsd surface-control

# Update bootloader
sudo mkinitcpio -P
sudo grub-mkconfig -o /boot/grub/grub.cfg  # or update rEFInd

# Enable services
sudo systemctl enable --now iptsd

# Reboot
reboot
```

### Kernel Parameters (rEFInd)

```bash
# /boot/efi/EFI/refind/refind.conf - add to boot options:
options "root=/dev/mapper/cryptouter rootflags=subvol=@kde \
  quiet splash \
  mem_sleep_default=deep \
  nvme.noacpi=1 \
  i915.enable_psr=0"
```

### Webcam Workaround

Since IPU6 cameras don't work reliably on Linux:
- **Mode A:** Boot into Windows for video calls
- **Mode B:** Use Windows VM with USB passthrough (from KDE host)
- **Alternative:** USB webcam (works immediately)

---

## User & Authentication Configuration

### Authentication Model: Single Password + Auto-Login

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SINGLE PASSWORD AUTHENTICATION                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ANON Profile:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Enter ANON   â”‚  â†’  â”‚  OUTER LUKS  â”‚  â†’  â”‚  Auto-login  â”‚                â”‚
â”‚  â”‚ LUKS passwordâ”‚     â”‚   unlocked   â”‚     â”‚  as 'anon'   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                             â”‚
â”‚  AUTH Profile:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Enter AUTH   â”‚  â†’  â”‚ OUTER+INNER  â”‚  â†’  â”‚  Auto-login  â”‚                â”‚
â”‚  â”‚ LUKS passwordâ”‚     â”‚   unlocked   â”‚     â”‚  as 'diego'  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                             â”‚
â”‚  ONE PASSWORD = Full access (LUKS is the security layer)                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Users

| User | Password | UID | Host sudo | Podman/Container | Auto-login | Profile |
|------|----------|-----|-----------|------------------|------------|---------|
| `anon` | `1234567890` | 1000 | **NO** | âœ“ Root inside containers | âœ“ After ANON LUKS | ANON |
| `diego` | `1234567890` | 1000 | **NOPASSWD** | âœ“ Root inside containers | âœ“ After AUTH LUKS | AUTH |

```bash
# ANON user - NO host sudo, but can run rootless containers
useradd -m -u 1000 -s /bin/bash anon
echo "anon:1234567890" | chpasswd
usermod -aG podman anon  # Can run containers (rootless)
# NOT in wheel group - cannot sudo on host

# AUTH user (diego) - full sudo + containers
useradd -m -u 1000 -G wheel -s /bin/bash diego
echo "diego:1234567890" | chpasswd
usermod -aG podman diego
echo "diego ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/diego
chmod 440 /etc/sudoers.d/diego
```

### Podman Rootless Setup

```bash
# Enable rootless podman for anon (can be root INSIDE containers)
loginctl enable-linger anon
loginctl enable-linger diego

# Verify anon can run containers
su - anon
podman run --rm -it alpine sh
# Inside container: whoami â†’ root
# On host: anon still can't sudo
```

### Configure Auto-Login

**KDE (SDDM):**
```bash
# /etc/sddm.conf.d/autologin.conf
[Autologin]
User=diego          # or 'anon' for ANON profile
Session=plasma.desktop
```

**Light (LightDM/getty):**
```bash
# /etc/systemd/system/getty@tty1.service.d/autologin.conf
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin diego --noclear %I $TERM
# or 'anon' for ANON profile
```

### Permission Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PERMISSION COMPARISON                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  anon (ANON Profile):                                                       â”‚
â”‚  â”œâ”€â”€ Host system: REGULAR USER (no sudo)                                    â”‚
â”‚  â”œâ”€â”€ Cannot: install packages, modify system, access /etc                   â”‚
â”‚  â”œâ”€â”€ Can: run podman containers                                             â”‚
â”‚  â””â”€â”€ Inside container: ROOT (full control inside container only)            â”‚
â”‚                                                                             â”‚
â”‚  diego (AUTH Profile):                                                      â”‚
â”‚  â”œâ”€â”€ Host system: FULL SUDO (NOPASSWD)                                      â”‚
â”‚  â”œâ”€â”€ Can: everything on host                                                â”‚
â”‚  â”œâ”€â”€ Can: run podman containers                                             â”‚
â”‚  â””â”€â”€ Inside container: ROOT                                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Security Model:**
- LUKS password = THE security (protects all data)
- User password = Not needed (auto-login)
- anon: No host sudo, but root inside containers (isolated)
- diego: Full sudo + containers (trusted after AUTH LUKS)

### SSH Configuration

```bash
# /etc/ssh/sshd_config
PubkeyAuthentication yes
PubkeyAcceptedKeyTypes ssh-rsa,rsa-sha2-256,rsa-sha2-512
PasswordAuthentication yes          # TODO: Disable after setup complete
PermitEmptyPasswords no
PermitRootLogin no
MaxAuthTries 5

# No 2FA required for SSH
```

**TODO:** After setup is stable, disable SSH password:
```bash
# Change to: PasswordAuthentication no
# Then: systemctl restart sshd
```

### Human Login 2FA Options (OPTIONAL)

2FA is **NOT enabled by default**. Users can optionally configure one of these methods:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         2FA OPTIONS FOR LOGIN                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Option A: TOTP (Aegis App)                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  Time-based one-time passwords via Aegis app on phone                       â”‚
â”‚  Install: rpm-ostree install google-authenticator                           â”‚
â”‚  Setup: google-authenticator (scan QR with Aegis)                           â”‚
â”‚  PAM: auth required pam_google_authenticator.so nullok                      â”‚
â”‚                                                                             â”‚
â”‚  Option B: Passkey (Bitwarden)                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  WebAuthn passkey stored in Bitwarden                                       â”‚
â”‚  Install: rpm-ostree install libfido2 pam-u2f                               â”‚
â”‚  Setup: pamu2fcfg > ~/.config/Yubico/u2f_keys                               â”‚
â”‚  PAM: auth sufficient pam_u2f.so cue                                        â”‚
â”‚                                                                             â”‚
â”‚  Option C: FIDO2 Key (YubiKey / Phone)                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚
â”‚  Hardware security key or phone as FIDO2 authenticator                      â”‚
â”‚  Install: rpm-ostree install pam-u2f                                        â”‚
â”‚  Setup: pamu2fcfg > ~/.config/Yubico/u2f_keys                               â”‚
â”‚  PAM: auth sufficient pam_u2f.so cue [cue_prompt=Touch key]                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Authentication Matrix

| Context | anon | diego | Method |
|---------|------|-------|--------|
| LUKS unlock | ANON password | AUTH password | Single password entry |
| GUI/Console | **Auto-login** | **Auto-login** | No password needed |
| SSH | RSA key (password fallback) | RSA key (password fallback) | No 2FA |
| Host sudo | **BLOCKED** | **NOPASSWD** | anon cannot modify host |
| Podman containers | âœ“ Root inside | âœ“ Root inside | Rootless containers |
| Screen lock | Optional | Optional | 2FA optional |

**Notes:**
- LUKS password is THE security layer
- Auto-login after LUKS unlock (no second password)
- anon: No host sudo, but can run containers with root inside
- diego: Full host sudo + containers

---

## Security Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            OUTSIDE WORLD                                         â”‚
â”‚                          (sees encrypted data)                                   â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚   Password "anon"                         Password "auth"               â”‚   â”‚
â”‚   â”‚        â”‚                                        â”‚                        â”‚   â”‚
â”‚   â”‚        â–¼                                        â–¼                        â”‚   â”‚
â”‚   â”‚   Opens OUTER                             Opens OUTER                    â”‚   â”‚
â”‚   â”‚   LUKS only                               + INNER LUKS                   â”‚   â”‚
â”‚   â”‚        â”‚                                        â”‚                        â”‚   â”‚
â”‚   â”‚        â–¼                                        â–¼                        â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚   â”‚ ANON Profile  â”‚                   â”‚ ANON + AUTH Profiles    â”‚       â”‚   â”‚
â”‚   â”‚   â”‚ Tor, Privacy  â”‚                   â”‚ Full access to all      â”‚       â”‚   â”‚
â”‚   â”‚   â”‚ Burner IDs    â”‚                   â”‚ Personal + Anonymous    â”‚       â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Access Matrix:**

| Password | Outer LUKS | Inner LUKS | Sees ANON | Sees AUTH |
|----------|------------|------------|-----------|-----------|
| ANON | âœ“ Unlocks | âœ— Locked | âœ“ | âœ— |
| AUTH | âœ“ Unlocks | âœ“ Unlocks | âœ“ | âœ“ |

---

## Environments

### Available Modes (2 boots + Windows, session selection at SDDM)

| Boot Entry | LUKS Password | Auto-login User | Session Options |
|------------|---------------|-----------------|-----------------|
| Kinoite ANON | ANON | anon | KDE, Openbox, Android, Tor Kiosk |
| Kinoite AUTH | AUTH | diego | KDE, Openbox, Android, Chrome Kiosk |
| Windows | - | - | Windows (Camera/Firmware) |

### Session Matrix

| Session | ANON | AUTH | Purpose |
|---------|------|------|---------|
| **KDE Plasma** | âœ“ | âœ“ | Full desktop environment |
| **Openbox** | âœ“ | âœ“ | Lightweight, focused work |
| **Android (Waydroid)** | âœ“ | âœ“ | Mobile apps, touch mode |
| **Tor Kiosk** | âœ“ | âœ— | Anonymous browsing (ANON only) |
| **Chrome Kiosk** | âœ— | âœ“ | Google services (AUTH only) |

**Single OS = KDE + Openbox + Waydroid + Kiosk modes (~12 GB)**
**All dev tools run in Podman containers**
**Session selection happens at SDDM login screen (or via session switcher)**

---

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              rEFInd Boot Manager                                        â”‚
â”‚                        (Surface UEFI - Secure Boot OFF)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  EFI   â”‚                     OUTER LUKS (~200 GB)                       â”‚Win11 â”‚   â”‚
â”‚  â”‚ 500MB  â”‚                (Password: ANON or AUTH)                        â”‚20 GB â”‚   â”‚
â”‚  â”‚        â”‚                                                                â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BTRFS Pool â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚                                                            â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Single OS Root (immutable /usr) â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚  @root (~12GB) - Kinoite + KDE + Openbox + Waydroid   â”‚ â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚                                                            â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ANON Profile (mutable state) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚  @etc-anon     â”‚  @var-anon     â”‚ System configs/state â”‚ â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚  @tools-anon   â”‚  @vault-anon   â”‚  @shared-anon        â”‚ â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚  Tor, Privacy  â”‚  Burner IDs    â”‚  Anon-only files     â”‚ â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚                                                            â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Shared Data (both profiles) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚  @shared-common (~25GB) - Downloads, Media, Transfer   â”‚â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚                                                            â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ INNER LUKS (auth.luks ~55GB) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚            (Only AUTH password unlocks)                 â”‚â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AUTH Profile (private) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚  â”‚  @etc-auth     â”‚  @var-auth     â”‚ Hidden configs!  â”‚ â”‚â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚  â”‚  @tools-auth   â”‚  @vault-auth   â”‚  @shared-auth    â”‚ â”‚â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚  â”‚  Claude, Git   â”‚  SSH/GPG/API   â”‚  Docs, Projects  â”‚ â”‚â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚                                                            â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚  @snapshots (dynamic) - BTRFS snapshots for rollback       â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â”‚                                                            â”‚ â”‚      â”‚   â”‚
â”‚  â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â”‚                          + swapfile inside LUKS (16 GB)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Disk Layout (256GB NVMe)

| Partition | Size | Filesystem | Content |
|-----------|------|------------|---------|
| nvme0n1p1 | 500 MB | FAT32 | EFI System |
| nvme0n1p2 | ~215 GB | LUKS + BTRFS | Encrypted Pool (includes swap) |
| nvme0n1p3 | 20 GB | NTFS | Windows (Camera) |

**Total: ~236 GB**

**Note:** Swap is a file inside LUKS pool (`/mnt/pool/swapfile`) for security - no unencrypted swap partition.

### BTRFS Subvolumes (Outer LUKS)

| Subvolume | Size | Access | Purpose |
|-----------|------|--------|---------|
| @root | ~12 GB | Both | Single OS: Kinoite + KDE + Openbox + Waydroid (immutable /usr) |
| @etc-anon | ~200 MB | ANON | ANON's /etc (system configs, hostname, network) |
| @var-anon | ~3 GB | ANON | ANON's /var (logs, containers state, cache) |
| @shared-common | ~25 GB | Both | **Shared data** (Downloads, Media, Transfer) |
| @tools-anon | ~5 GB | ANON | Tor, DNSCrypt, Privacy containers |
| @vault-anon | ~1 GB | ANON | Burner SSH keys, disposable IDs |
| @shared-anon | ~10 GB | ANON | ANON-only private files |
| @snapshots | dynamic | Both | BTRFS snapshots for rollback |
| auth.luks | ~55 GB | AUTH only | Inner encrypted container |

### BTRFS Subvolumes (Inner LUKS - auth.luks)

| Subvolume | Size | Access | Purpose |
|-----------|------|--------|---------|
| @etc-auth | ~200 MB | AUTH only | AUTH's /etc (hidden from ANON!) |
| @var-auth | ~3 GB | AUTH only | AUTH's /var (hidden from ANON!) |
| @tools-auth | ~10 GB | AUTH only | Claude, Git, Dev containers |
| @vault-auth | ~1 GB | AUTH only | SSH, GPG, API keys |
| @shared-auth | ~35 GB | AUTH only | Documents, Projects |

### Why /etc and /var Are Separated

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPLETE PROFILE ISOLATION                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   @etc contains (profile-specific):          @var contains:             â”‚
â”‚   â”œâ”€â”€ /etc/hostname                          â”œâ”€â”€ /var/log/              â”‚
â”‚   â”œâ”€â”€ /etc/NetworkManager/                   â”œâ”€â”€ /var/lib/containers/   â”‚
â”‚   â”œâ”€â”€ /etc/ssh/ssh_host_*                    â”œâ”€â”€ /var/lib/flatpak/      â”‚
â”‚   â”œâ”€â”€ /etc/sddm.conf.d/                      â”œâ”€â”€ /var/cache/            â”‚
â”‚   â””â”€â”€ /etc/systemd/                          â””â”€â”€ /var/tmp/              â”‚
â”‚                                                                          â”‚
â”‚   ANON boots â†’ mounts @etc-anon, @var-anon                              â”‚
â”‚   AUTH boots â†’ mounts @etc-auth, @var-auth (from inner LUKS!)           â”‚
â”‚                                                                          â”‚
â”‚   Result: ZERO cross-contamination, ZERO config leakage                 â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Access Summary

| Data Location | ANON sees | AUTH sees | Purpose |
|---------------|-----------|-----------|---------|
| ~/shared/ | âœ“ | âœ“ | Common downloads, media, transfer zone |
| ~/private/ | âœ“ (own) | âœ“ (own) | Profile-specific private files |
| ~/vault/ | âœ“ (anon) | âœ“ (diego) | Secrets (never cross-accessible) |
| /mnt/anon/ | - | âœ“ (optional) | AUTH can browse ANON files |

---

## Boot Menu

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            rEFInd Boot Manager                                   â”‚
â”‚                                                                                  â”‚
â”‚         ğŸ”’ Kinoite ANON          ğŸ” Kinoite AUTH          ğŸªŸ Windows            â”‚
â”‚         (ANON password)          (AUTH password)          (Camera)              â”‚
â”‚                                                                                  â”‚
â”‚              Use arrows to select, Enter to boot                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After LUKS unlock â†’ SDDM session selection:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ANON Boot â†’ SDDM           â”‚    â”‚       AUTH Boot â†’ SDDM          â”‚
â”‚                                 â”‚    â”‚                                 â”‚
â”‚  Session: [â–¼ KDE Plasma    ]    â”‚    â”‚  Session: [â–¼ KDE Plasma    ]    â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚           â”‚ KDE Plasma     â”‚    â”‚    â”‚           â”‚ KDE Plasma     â”‚    â”‚
â”‚           â”‚ Openbox        â”‚    â”‚    â”‚           â”‚ Openbox        â”‚    â”‚
â”‚           â”‚ Android        â”‚    â”‚    â”‚           â”‚ Android        â”‚    â”‚
â”‚           â”‚ Tor Kiosk      â”‚    â”‚    â”‚           â”‚ Chrome Kiosk   â”‚    â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                 â”‚    â”‚                                 â”‚
â”‚  User: anon (auto-login)        â”‚    â”‚  User: diego (auto-login)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Boot Flow

### ANON Boot

```
1. Select "Kinoite ANON" in rEFInd
2. Prompt: "Enter LUKS password"
3. Enter ANON password â†’ Unlocks OUTER LUKS only
4. Mounts from OUTER LUKS:
   - @root â†’ /           (shared OS, immutable /usr)
   - @etc-anon â†’ /etc    (ANON's system config)
   - @var-anon â†’ /var    (ANON's logs, containers, cache)
   - @tools-anon, @vault-anon, @shared-anon, @shared-common
5. Inner LUKS (auth.luks) remains LOCKED - AUTH data INVISIBLE
6. SDDM starts â†’ Session switcher OR auto-login
7. Choose: KDE Plasma | Openbox | Android | Tor Kiosk
8. Desktop loads with ANON profile
```

### AUTH Boot

```
1. Select "Kinoite AUTH" in rEFInd
2. Prompt: "Enter LUKS password"
3. Enter AUTH password â†’ Unlocks OUTER LUKS
4. Keyfile inside unlocks INNER LUKS automatically
5. Mounts from INNER LUKS (hidden from ANON!):
   - @etc-auth â†’ /etc    (AUTH's system config)
   - @var-auth â†’ /var    (AUTH's logs, containers, cache)
   - @tools-auth, @vault-auth, @shared-auth
6. Mounts from OUTER LUKS:
   - @root â†’ /           (shared OS, immutable /usr)
   - @shared-common
   - Optionally @*-anon â†’ /mnt/anon/ for full access
7. SDDM starts â†’ Session switcher OR auto-login
8. Choose: KDE Plasma | Openbox | Android | Chrome Kiosk
9. Desktop loads with AUTH profile (full access to both)
```

### Session Selection with Auto-Login

**Problem:** Auto-login skips SDDM, so no session choice.

**Solution:** Session Switcher script runs after auto-login:

```bash
# /usr/local/bin/session-switcher.sh
# Shows graphical session picker on first login, remembers choice

#!/bin/bash
LAST_SESSION="$HOME/.config/last-session"

if [[ ! -f "$LAST_SESSION" ]] || [[ "$1" == "--choose" ]]; then
    # Show session picker (zenity/kdialog)
    SESSION=$(zenity --list --title="Choose Session" \
        --column="Session" "plasma" "openbox" "android" "kiosk")
    echo "$SESSION" > "$LAST_SESSION"
fi

# Switch to chosen session if different from current
# (logout and re-login with selected session)
```

**Alternative:** Disable auto-login, use SDDM session dropdown (requires entering password twice: LUKS + SDDM)

---

## Containerized Tooling

Each OS is **minimal** (GUI + terminal + file manager only). All tools run in **Podman containers**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Minimal Host OS (~5-10 GB)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚   Desktop   â”‚  â”‚  Terminal   â”‚  â”‚    File     â”‚                         â”‚
â”‚  â”‚ Environment â”‚  â”‚  (Konsole)  â”‚  â”‚   Manager   â”‚                         â”‚
â”‚  â”‚  (KDE/OB)   â”‚  â”‚             â”‚  â”‚  (Dolphin)  â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Podman Container (~2-10 GB)                        â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  ANON Container:              AUTH Container:                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚   Tor   â”‚ â”‚DNSCrypt â”‚     â”‚ Claude  â”‚ â”‚  Git    â”‚ â”‚ Python  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚         â”‚ â”‚  Proxy  â”‚     â”‚  Code   â”‚ â”‚         â”‚ â”‚ Node.js â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Container Profiles

| Profile | Container | Tools | Use Case |
|---------|-----------|-------|----------|
| **ANON** | cloud-connect:anon | Tor, DNSCrypt, Privacy tools | Anonymous browsing |
| **AUTH** | cloud-connect:auth | Claude, Git, Python, Node, Rust | Development |

---

## Vault Structure

### @vault-anon (Burner identities)

```
@vault-anon/
â”œâ”€â”€ tor/              â† Tor configs
â”œâ”€â”€ burner-keys/      â† Disposable SSH keys
â”œâ”€â”€ temp-gpg/         â† Temporary GPG keys
â””â”€â”€ anon-configs/     â† Anonymous service configs
```

### @vault-auth (Personal identity)

```
@vault-auth/
â”œâ”€â”€ ssh/              â† Personal SSH keys
â”‚   â”œâ”€â”€ id_rsa
â”‚   â””â”€â”€ known_hosts
â”œâ”€â”€ gpg/              â† Personal GPG keys
â”œâ”€â”€ api/              â† API tokens
â”‚   â”œâ”€â”€ anthropic.key
â”‚   â”œâ”€â”€ google.key
â”‚   â””â”€â”€ github.key
â”œâ”€â”€ cloud/            â† Cloud CLI configs
â”‚   â”œâ”€â”€ oci/
â”‚   â””â”€â”€ gcloud/
â””â”€â”€ bitwarden/        â† Password manager backup
```

---

## LUKS Setup Commands

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 1: Create partitions
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# p1: EFI (500MB), p2: LUKS (~215GB), p3: Windows (20GB)
# Swap is a file inside LUKS, not a partition

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 2: Setup OUTER LUKS with two key slots
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Create LUKS container (first password = ANON)
cryptsetup luksFormat /dev/nvme0n1p2
# Enter ANON password

# Add second key slot (AUTH password)
cryptsetup luksAddKey /dev/nvme0n1p2
# Enter existing (ANON) password, then new (AUTH) password

# Open outer LUKS
cryptsetup open /dev/nvme0n1p2 cryptouter

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 3: Create BTRFS and subvolumes in OUTER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

mkfs.btrfs -L pool /dev/mapper/cryptouter
mount /dev/mapper/cryptouter /mnt

# Single OS root (KDE + Openbox + Waydroid) - /usr is immutable via ostree
btrfs subvolume create /mnt/@root

# ANON profile - mutable system state (hidden from AUTH only by choice)
btrfs subvolume create /mnt/@etc-anon      # ANON's /etc (hostname, network, ssh host keys)
btrfs subvolume create /mnt/@var-anon      # ANON's /var (logs, containers, cache)
btrfs subvolume create /mnt/@tools-anon    # ANON containers
btrfs subvolume create /mnt/@vault-anon    # ANON secrets
btrfs subvolume create /mnt/@shared-anon   # ANON private files

# Shared data (accessible by both profiles)
btrfs subvolume create /mnt/@shared-common

# Snapshots
btrfs subvolume create /mnt/@snapshots

# Create swap file inside LUKS
dd if=/dev/zero of=/mnt/swapfile bs=1G count=16 status=progress
chmod 600 /mnt/swapfile
mkswap /mnt/swapfile

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 4: Create INNER LUKS container for AUTH
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Create container file (~60GB)
dd if=/dev/zero of=/mnt/auth.luks bs=1M count=60000 status=progress

# Format as LUKS (use keyfile derived from AUTH password)
cryptsetup luksFormat /mnt/auth.luks

# Create keyfile that only AUTH password can access
# (Store encrypted in outer LUKS, decrypted by initramfs based on password)
dd if=/dev/urandom of=/mnt/.auth-keyfile bs=4096 count=1
chmod 000 /mnt/.auth-keyfile
cryptsetup luksAddKey /mnt/auth.luks /mnt/.auth-keyfile

# Open inner LUKS
cryptsetup open /mnt/auth.luks cryptinner --key-file /mnt/.auth-keyfile

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 5: Create BTRFS and subvolumes in INNER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

mkfs.btrfs -L auth /dev/mapper/cryptinner
mount /dev/mapper/cryptinner /mnt/auth

# AUTH profile - mutable system state (HIDDEN from ANON - inside inner LUKS!)
btrfs subvolume create /mnt/auth/@etc-auth      # AUTH's /etc (reveals identity!)
btrfs subvolume create /mnt/auth/@var-auth      # AUTH's /var (activity history!)
btrfs subvolume create /mnt/auth/@tools-auth    # AUTH containers
btrfs subvolume create /mnt/auth/@vault-auth    # AUTH secrets
btrfs subvolume create /mnt/auth/@shared-auth   # AUTH private files

umount /mnt/auth
umount /mnt
```

---

## SDDM Session Setup

### Install Desktop Environments

```bash
# On Fedora Kinoite (rpm-ostree)
rpm-ostree install \
    openbox obconf tint2 nitrogen feh \
    cage \
    chromium \
    zenity

# Reboot to apply
systemctl reboot
```

### Create Custom Session Files

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Android Session (Waydroid fullscreen)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
cat > /usr/share/wayland-sessions/android.desktop << 'EOF'
[Desktop Entry]
Name=Android (Waydroid)
Comment=Full Android UI via Waydroid
Exec=cage -- waydroid show-full-ui
Type=Application
DesktopNames=Android
EOF

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Tor Kiosk Session (ANON only)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
cat > /usr/share/wayland-sessions/tor-kiosk.desktop << 'EOF'
[Desktop Entry]
Name=Tor Kiosk
Comment=Anonymous browsing with Tor Browser
Exec=cage -- torbrowser-launcher
Type=Application
DesktopNames=TorKiosk
EOF

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Chrome Kiosk Session (AUTH only)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
cat > /usr/share/wayland-sessions/chrome-kiosk.desktop << 'EOF'
[Desktop Entry]
Name=Chrome Kiosk
Comment=Google Chrome in kiosk mode
Exec=cage -- chromium --kiosk --start-fullscreen
Type=Application
DesktopNames=ChromeKiosk
EOF
```

### Profile-Specific Session Filtering

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Boot script to enable/disable sessions based on profile
# /usr/local/bin/configure-sessions.sh (runs at boot via systemd)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#!/bin/bash

SESSIONS_DIR="/usr/share/wayland-sessions"

# Detect profile based on mounted subvolumes
if mountpoint -q /home/diego/vault 2>/dev/null; then
    PROFILE="auth"
else
    PROFILE="anon"
fi

# Enable/disable sessions based on profile
if [[ "$PROFILE" == "anon" ]]; then
    # ANON: Enable Tor, disable Chrome
    chmod 644 "$SESSIONS_DIR/tor-kiosk.desktop"
    chmod 000 "$SESSIONS_DIR/chrome-kiosk.desktop"
    # Set auto-login user
    sed -i 's/^User=.*/User=anon/' /etc/sddm.conf.d/autologin.conf
else
    # AUTH: Enable Chrome, disable Tor
    chmod 000 "$SESSIONS_DIR/tor-kiosk.desktop"
    chmod 644 "$SESSIONS_DIR/chrome-kiosk.desktop"
    # Set auto-login user
    sed -i 's/^User=.*/User=diego/' /etc/sddm.conf.d/autologin.conf
fi
```

### Session Switcher (for auto-login)

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# /usr/local/bin/session-switcher.sh
# Shows session picker after auto-login, allows switching without logout
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#!/bin/bash

LAST_SESSION="$HOME/.config/last-session"
CURRENT_SESSION="${XDG_CURRENT_DESKTOP:-plasma}"

# Get available sessions based on profile
if [[ "$USER" == "anon" ]]; then
    SESSIONS="KDE Plasma|Openbox|Android|Tor Kiosk"
else
    SESSIONS="KDE Plasma|Openbox|Android|Chrome Kiosk"
fi

# Show picker if no saved session or --choose flag
if [[ ! -f "$LAST_SESSION" ]] || [[ "$1" == "--choose" ]]; then
    CHOICE=$(zenity --list --title="Choose Session" \
        --text="Select your desktop environment:" \
        --column="Session" \
        $(echo "$SESSIONS" | tr '|' '\n'))

    if [[ -n "$CHOICE" ]]; then
        echo "$CHOICE" > "$LAST_SESSION"

        # Map choice to session file
        case "$CHOICE" in
            "KDE Plasma") SESSION="plasma" ;;
            "Openbox") SESSION="openbox" ;;
            "Android") SESSION="android" ;;
            "Tor Kiosk") SESSION="tor-kiosk" ;;
            "Chrome Kiosk") SESSION="chrome-kiosk" ;;
        esac

        # If different from current, logout and switch
        if [[ "$SESSION" != "$CURRENT_SESSION" ]]; then
            # Update SDDM config and logout
            echo "Session=$SESSION.desktop" >> ~/.config/sddm-session
            loginctl terminate-user "$USER"
        fi
    fi
fi
```

### Auto-Start Session Switcher

```bash
# ~/.config/autostart/session-switcher.desktop
[Desktop Entry]
Name=Session Switcher
Exec=/usr/local/bin/session-switcher.sh
Type=Application
X-GNOME-Autostart-enabled=true
```

---

## Mount Configuration

### ANON Boot fstab

```bash
# OS root (single OS for all sessions) - /usr is immutable via ostree
/dev/mapper/cryptouter  /                      btrfs  subvol=@root,noatime  0 0

# ANON's mutable system state (CRITICAL for profile isolation!)
/dev/mapper/cryptouter  /etc                   btrfs  subvol=@etc-anon,noatime  0 0
/dev/mapper/cryptouter  /var                   btrfs  subvol=@var-anon,noatime  0 0

# Shared data (accessible by both profiles)
/dev/mapper/cryptouter  /home/anon/shared      btrfs  subvol=@shared-common  0 0

# ANON profile data
/dev/mapper/cryptouter  /home/anon/tools       btrfs  subvol=@tools-anon  0 0
/dev/mapper/cryptouter  /home/anon/vault       btrfs  subvol=@vault-anon  0 0
/dev/mapper/cryptouter  /home/anon/private     btrfs  subvol=@shared-anon 0 0

# AUTH profile - NOT MOUNTED (inner LUKS locked)

# Volatile tmpfs for sensitive temp data
tmpfs  /tmp      tmpfs  defaults,noatime,mode=1777,size=2G  0 0
```

### AUTH Boot fstab

```bash
# OS root (single OS for all sessions) - /usr is immutable via ostree
/dev/mapper/cryptouter  /                       btrfs  subvol=@root,noatime  0 0

# AUTH's mutable system state (from INNER LUKS - hidden from ANON!)
/dev/mapper/cryptinner  /etc                    btrfs  subvol=@etc-auth,noatime  0 0
/dev/mapper/cryptinner  /var                    btrfs  subvol=@var-auth,noatime  0 0

# Shared data (accessible by both profiles)
/dev/mapper/cryptouter  /home/diego/shared      btrfs  subvol=@shared-common  0 0

# AUTH profile data (from inner LUKS)
/dev/mapper/cryptinner  /home/diego/tools       btrfs  subvol=@tools-auth  0 0
/dev/mapper/cryptinner  /home/diego/vault       btrfs  subvol=@vault-auth  0 0
/dev/mapper/cryptinner  /home/diego/private     btrfs  subvol=@shared-auth 0 0

# Optional: mount ANON data for full access (AUTH can see everything)
/dev/mapper/cryptouter  /mnt/anon/private       btrfs  subvol=@shared-anon  0 0
/dev/mapper/cryptouter  /mnt/anon/vault         btrfs  subvol=@vault-anon   0 0
/dev/mapper/cryptouter  /mnt/anon/etc           btrfs  subvol=@etc-anon     0 0
/dev/mapper/cryptouter  /mnt/anon/var           btrfs  subvol=@var-anon     0 0

# Volatile tmpfs for sensitive temp data
tmpfs  /tmp      tmpfs  defaults,noatime,mode=1777,size=2G  0 0
```

### Home Directory Structure

```
/home/anon/                         /home/diego/
â”œâ”€â”€ shared/    â†’ @shared-common     â”œâ”€â”€ shared/    â†’ @shared-common
â”‚   â”œâ”€â”€ Downloads/                  â”‚   â”œâ”€â”€ Downloads/
â”‚   â”œâ”€â”€ Music/                      â”‚   â”œâ”€â”€ Music/
â”‚   â”œâ”€â”€ Videos/                     â”‚   â”œâ”€â”€ Videos/
â”‚   â””â”€â”€ Transfer/                   â”‚   â””â”€â”€ Transfer/
â”‚                                   â”‚
â”œâ”€â”€ tools/     â†’ @tools-anon        â”œâ”€â”€ tools/     â†’ @tools-auth
â”‚   â””â”€â”€ (containers, scripts)       â”‚   â””â”€â”€ (containers, dev tools)
â”‚                                   â”‚
â”œâ”€â”€ private/   â†’ @shared-anon       â”œâ”€â”€ private/   â†’ @shared-auth
â”‚   â””â”€â”€ (anon-only files)           â”‚   â”œâ”€â”€ Documents/
â”‚                                   â”‚   â””â”€â”€ Projects/
â”‚                                   â”‚
â””â”€â”€ vault/     â†’ @vault-anon        â””â”€â”€ vault/     â†’ @vault-auth
    â””â”€â”€ burner-keys/                    â”œâ”€â”€ ssh/
                                        â”œâ”€â”€ gpg/
                                        â””â”€â”€ api/

System Directories (mounted per profile):

ANON boots:                         AUTH boots:
/etc  â†’ @etc-anon                   /etc  â†’ @etc-auth (from inner LUKS!)
/var  â†’ @var-anon                   /var  â†’ @var-auth (from inner LUKS!)
```

---

## Waydroid (Android Container)

Waydroid runs inside KDE/Light, stores data in @android subvolume:

```bash
# Install on Kinoite
rpm-ostree install waydroid
systemctl reboot

# Initialize with Google Apps
sudo waydroid init -s GAPPS

# Launch full Android UI
waydroid show-full-ui
```

**ANON Android:** Uses @tools-anon, @vault-anon
**AUTH Android:** Uses @tools-auth, @vault-auth

---

## Quick Reference

| Task | Boot | Session | Password |
|------|------|---------|----------|
| Anonymous browsing | Kinoite ANON | Tor Kiosk | ANON |
| Lightweight anon work | Kinoite ANON | Openbox | ANON |
| Full anon desktop | Kinoite ANON | KDE Plasma | ANON |
| Development work | Kinoite AUTH | KDE Plasma | AUTH |
| Lightweight dev work | Kinoite AUTH | Openbox | AUTH |
| Google services | Kinoite AUTH | Chrome Kiosk | AUTH |
| Android apps (anon) | Kinoite ANON | Android | ANON |
| Android apps (personal) | Kinoite AUTH | Android | AUTH |
| Video call (webcam) | Windows | - | None |
| Firmware updates | Windows | - | None |

---

## Security Summary

| Layer | Protection | Method |
|-------|------------|--------|
| External (theft) | All data encrypted | LUKS |
| ANON profile | Separate identity | Own vault/tools |
| AUTH profile | Personal data hidden | Nested LUKS |
| Between boots | Complete separation | Different mounts |

---

## Hybrid Access Modes

The architecture supports **two access modes**: direct multi-boot for maximum performance, or VM mode from KDE for convenience.

### Mode A: Multi-Boot (via rEFInd)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BARE METAL BOOT                                   â”‚
â”‚                   (Full hardware access, max performance)                â”‚
â”‚                                                                         â”‚
â”‚   rEFInd â†’ Select OS â†’ LUKS unlock â†’ Boot directly on hardware          â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚  KDE   â”‚ â”‚  KDE   â”‚ â”‚ Light  â”‚ â”‚ Light  â”‚ â”‚ Windows â”‚              â”‚
â”‚   â”‚  Anon  â”‚ â”‚  Auth  â”‚ â”‚  Anon  â”‚ â”‚  Auth  â”‚ â”‚         â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Use when:**
- Maximum performance needed (gaming, video editing)
- Full hardware access (all 8GB RAM)
- Battery optimization
- Clean profile isolation (no host traces)

---

### Mode B: VM Mode (from KDE Host)

KDE serves as host OS, launching other environments as VMs via **Kata Containers** (for Linux) and **QEMU/KVM** (for Windows).

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     KDE AUTH as Host                                     â”‚
â”‚               (Inner LUKS unlocked - full access)                        â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚                    KDE Kinoite Auth (HOST)                         â”‚ â”‚
â”‚   â”‚                        ~3-4 GB RAM                                 â”‚ â”‚
â”‚   â”‚                                                                    â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚   â”‚   â”‚  Kata VM:    â”‚  â”‚  Kata VM:    â”‚  â”‚  QEMU/KVM:   â”‚           â”‚ â”‚
â”‚   â”‚   â”‚ Light Anon   â”‚  â”‚ Light Auth   â”‚  â”‚   Windows    â”‚           â”‚ â”‚
â”‚   â”‚   â”‚   ~1 GB      â”‚  â”‚   ~1 GB      â”‚  â”‚   ~2-3 GB    â”‚           â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚   â”‚                                                                    â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚ â”‚
â”‚   â”‚   â”‚  Waydroid:   â”‚  â”‚   Podman:    â”‚  (shares kernel,             â”‚ â”‚
â”‚   â”‚   â”‚   Android    â”‚  â”‚    Tools     â”‚   minimal overhead)          â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚ â”‚
â”‚   â”‚                                                                    â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     KDE ANON as Host                                     â”‚
â”‚                (Inner LUKS locked - ANON access only)                    â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚                    KDE Kinoite Anon (HOST)                         â”‚ â”‚
â”‚   â”‚                        ~3-4 GB RAM                                 â”‚ â”‚
â”‚   â”‚                                                                    â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚   â”‚   â”‚  Kata VM:    â”‚  â”‚  QEMU/KVM:   â”‚  â”‚   Podman:    â”‚           â”‚ â”‚
â”‚   â”‚   â”‚ Light Anon   â”‚  â”‚   Windows    â”‚  â”‚  Anon Tools  â”‚           â”‚ â”‚
â”‚   â”‚   â”‚   ~1 GB      â”‚  â”‚   ~2-3 GB    â”‚  â”‚              â”‚           â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚   â”‚                                                                    â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚ â”‚
â”‚   â”‚   â”‚  Waydroid:   â”‚   âœ— Light Auth (BLOCKED - no access)          â”‚ â”‚
â”‚   â”‚   â”‚ Android Anon â”‚   âœ— AUTH tools (BLOCKED - no access)          â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   âœ— @vault-auth (BLOCKED - inner LUKS locked) â”‚ â”‚
â”‚   â”‚                                                                    â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Use when:**
- Need multiple environments simultaneously
- Quick switching without reboot
- Testing/development across profiles
- Convenience over raw performance

---

### Mode B Access Matrix

| Host | Can Launch | Cannot Launch |
|------|------------|---------------|
| **KDE Auth** | Light Anon, Light Auth, Windows VM, Waydroid, All Podman containers | - |
| **KDE Anon** | Light Anon, Windows VM, Waydroid Anon, Anon Podman containers | Light Auth, AUTH tools, @vault-auth |

---

## Isolation Levels

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ISOLATION COMPARISON                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  STRONGEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º WEAKEST   â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Multi-Boot  â”‚   â”‚  Kata VM    â”‚   â”‚  QEMU/KVM   â”‚   â”‚   Podman    â”‚  â”‚
â”‚  â”‚             â”‚   â”‚             â”‚   â”‚             â”‚   â”‚  Container  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Separate    â”‚   â”‚ Micro-VM    â”‚   â”‚ Full VM     â”‚   â”‚ Namespace   â”‚  â”‚
â”‚  â”‚ boot, no    â”‚   â”‚ per         â”‚   â”‚ emulation   â”‚   â”‚ isolation   â”‚  â”‚
â”‚  â”‚ host kernel â”‚   â”‚ container   â”‚   â”‚             â”‚   â”‚ only        â”‚  â”‚
â”‚  â”‚             â”‚   â”‚             â”‚   â”‚             â”‚   â”‚             â”‚  â”‚
â”‚  â”‚ 100% RAM    â”‚   â”‚ ~1GB each   â”‚   â”‚ ~2-3GB each â”‚   â”‚ Shared RAM  â”‚  â”‚
â”‚  â”‚             â”‚   â”‚             â”‚   â”‚             â”‚   â”‚             â”‚  â”‚
â”‚  â”‚ Zero        â”‚   â”‚ Hardware    â”‚   â”‚ Hardware    â”‚   â”‚ Kernel      â”‚  â”‚
â”‚  â”‚ shared      â”‚   â”‚ virt        â”‚   â”‚ virt        â”‚   â”‚ shared      â”‚  â”‚
â”‚  â”‚ state       â”‚   â”‚ (VT-x)      â”‚   â”‚ (VT-x)      â”‚   â”‚             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â”‚  Use: Max       Use: Linux       Use: Windows      Use: Dev tools,       â”‚
â”‚  security,      envs from        from KDE,         Tor, DNSCrypt         â”‚
â”‚  performance    KDE host         webcam access                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Kata Containers Setup (KDE Host)

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Install Kata on Fedora Kinoite
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rpm-ostree install kata-containers
systemctl reboot

# Configure podman to use kata runtime
mkdir -p ~/.config/containers
cat > ~/.config/containers/containers.conf << 'EOF'
[engine]
runtime = "kata"
EOF

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Create Light Anon VM definition
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Option 1: Run @light subvolume as Kata VM
podman run --runtime=kata \
  -v /mnt/pool/@light:/rootfs:ro \
  -v /mnt/pool/@tools-anon:/var/lib/containers \
  -v /mnt/pool/@vault-anon:/home/user/vault \
  --memory=1g \
  light-anon:latest

# Option 2: Use pre-built Light image
podman run --runtime=kata \
  --name light-anon-vm \
  -e DISPLAY=$DISPLAY \
  -v /tmp/.X11-unix:/tmp/.X11-unix \
  --memory=1g \
  archlinux-openbox:anon
```

---

## QEMU/KVM Windows VM (KDE Host)

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Install QEMU/KVM on Fedora Kinoite
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rpm-ostree install qemu-kvm libvirt virt-manager
systemctl reboot

# Enable libvirt
sudo systemctl enable --now libvirtd

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Create Windows VM with USB passthrough for webcam
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

virt-install \
  --name windows-camera \
  --ram 3072 \
  --vcpus 2 \
  --disk /mnt/pool/windows.qcow2,size=20 \
  --cdrom /path/to/win11.iso \
  --os-variant win11 \
  --graphics spice \
  --video qxl \
  --hostdev 001.003  # USB webcam passthrough
```

**Webcam in VM:**
- Pass USB device to VM: `--hostdev <bus>.<device>`
- Find webcam: `lsusb | grep -i camera`
- Full webcam access without rebooting to Windows

---

## VM Storage Access (virtio-fs)

VMs access BTRFS subvolumes via **virtio-fs** for near-native performance:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          KDE Host                                        â”‚
â”‚                                                                         â”‚
â”‚   BTRFS Pool (/mnt/pool)                                                â”‚
â”‚   â”œâ”€â”€ @tools-anon  â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€ virtio-fs â”€â”€â”€â”€â–º  Light Anon VM           â”‚
â”‚   â”œâ”€â”€ @vault-anon  â”€â”€â”€â”€â”€â”€â”¤                      /home/user/vault        â”‚
â”‚   â”œâ”€â”€ @shared-anon â”€â”€â”€â”€â”€â”€â”˜                      /shared                 â”‚
â”‚   â”‚                                                                     â”‚
â”‚   â”œâ”€â”€ @tools-auth  â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€ virtio-fs â”€â”€â”€â”€â–º  Light Auth VM           â”‚
â”‚   â”œâ”€â”€ @vault-auth  â”€â”€â”€â”€â”€â”€â”¤                      /home/user/vault        â”‚
â”‚   â””â”€â”€ @shared-auth â”€â”€â”€â”€â”€â”€â”˜                      /shared                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```bash
# virtiofsd for shared folders
/usr/libexec/virtiofsd \
  --socket-path=/tmp/vhost-fs.sock \
  --shared-dir=/mnt/pool/@shared-anon \
  --cache=always

# In VM XML config
<filesystem type="mount">
  <driver type="virtiofs"/>
  <source socket="/tmp/vhost-fs.sock"/>
  <target dir="shared"/>
</filesystem>
```

---

## Memory Allocation (8GB Constraint)

| Mode | Host | VM 1 | VM 2 | Available |
|------|------|------|------|-----------|
| Multi-boot | 8 GB | - | - | Full RAM |
| KDE + Podman | 4 GB | - | - | 4 GB for containers |
| KDE + 1 Kata VM | 4 GB | 1 GB | - | 3 GB buffer |
| KDE + Windows VM | 3.5 GB | 3 GB | - | 1.5 GB buffer |
| KDE + Light + Win | 3 GB | 1 GB | 2.5 GB | Tight! |

**Recommendation:** Run max 1 VM at a time with 8GB RAM. Use multi-boot for heavy workloads.

---

## Use Case Decision Matrix

| Scenario | Recommended Mode | Why |
|----------|------------------|-----|
| Anonymous browsing (Tor) | Multi-boot â†’ Light Anon | Clean slate, no host traces |
| Quick webcam call | KDE Auth â†’ Windows VM | No reboot, USB passthrough |
| Heavy development | Multi-boot â†’ KDE Auth | Full 8GB RAM |
| Testing anon config | KDE Auth â†’ Light Anon VM | Quick iteration |
| Paranoid mode | Multi-boot â†’ Light Anon | Maximum isolation |
| Simultaneous profiles | KDE Auth â†’ Light Anon VM | Access both |
| Gaming/Video editing | Multi-boot â†’ Windows | Full GPU, RAM |

---

## Security Considerations

### Network Isolation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NETWORK CONFIGURATION                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ANON Profile:                       AUTH Profile:                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ DNS: DNSCrypt/Cloudflareâ”‚        â”‚ DNS: System default      â”‚        â”‚
â”‚  â”‚ Traffic: Tor/VPN        â”‚        â”‚ Traffic: Direct          â”‚        â”‚
â”‚  â”‚ MAC: Randomized         â”‚        â”‚ MAC: Hardware            â”‚        â”‚
â”‚  â”‚ Hostname: randomized    â”‚        â”‚ Hostname: surface-diego  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ANON Network Setup:**
```bash
# MAC randomization (NetworkManager)
nmcli connection modify "WiFi" wifi.cloned-mac-address random
nmcli connection modify "WiFi" ethernet.cloned-mac-address random

# Force DNS through DNSCrypt
echo "nameserver 127.0.0.1" > /etc/resolv.conf
chattr +i /etc/resolv.conf  # Prevent changes

# Random hostname on boot
hostnamectl set-hostname "$(openssl rand -hex 4)"
```

---

### Swap Encryption

**CRITICAL:** Swap must be encrypted to prevent RAM data leakage.

```bash
# Option 1: Swap inside LUKS (recommended)
# Create swap file inside encrypted pool
dd if=/dev/zero of=/mnt/pool/swapfile bs=1G count=16
chmod 600 /mnt/pool/swapfile
mkswap /mnt/pool/swapfile

# Option 2: Encrypted swap partition with random key (ephemeral)
# /etc/crypttab:
cryptswap /dev/nvme0n1p4 /dev/urandom swap,cipher=aes-xts-plain64,size=256

# /etc/fstab:
/dev/mapper/cryptswap none swap sw 0 0
```

**Chosen approach:** Swap inside LUKS pool (shares encryption with data).

---

### Hibernate/Suspend Security

| State | Risk | Mitigation |
|-------|------|------------|
| **Suspend (S3)** | RAM preserved, LUKS keys in memory | Lock screen, require password |
| **Hibernate (S4)** | RAM written to swap | Encrypted swap required |
| **Cold boot attack** | RAM can be frozen and read | Disable suspend, use shutdown |

**Recommendations:**
```bash
# Disable suspend for paranoid mode
systemctl mask suspend.target hibernate.target

# Or require LUKS password on resume
# /etc/systemd/system/luks-resume.service
```

---

### Cross-Profile Contamination Risks

| Risk | Vector | Mitigation | Status |
|------|--------|------------|--------|
| **Shared OS root** | /usr binaries | Immutable via ostree + separate /etc, /var | âœ“ SOLVED |
| **Config leakage** | /etc files reveal identity | Separate @etc-anon, @etc-auth subvolumes | âœ“ SOLVED |
| **Log leakage** | /var/log activity history | Separate @var-anon, @var-auth subvolumes | âœ“ SOLVED |
| **Container state** | /var/lib/containers | Each profile has own @var subvolume | âœ“ SOLVED |
| **Browser state** | Cookies, history | Separate browser profiles + tmpfs | âœ“ SOLVED |
| **Clipboard (VM)** | Copy between host/VM | Disable clipboard sharing | Manual |
| **BTRFS metadata** | File access times | noatime mount option | âœ“ SOLVED |

**Complete Isolation Summary:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FINAL ISOLATION MODEL                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Shared (intentionally):                                                â”‚
â”‚  â””â”€â”€ @root /usr   â†’ Immutable via ostree (cannot be modified at runtime)â”‚
â”‚  â””â”€â”€ @shared-common â†’ Explicit shared data (Downloads, Media)           â”‚
â”‚                                                                          â”‚
â”‚  Isolated per profile:                                                  â”‚
â”‚  â”œâ”€â”€ /etc         â†’ @etc-anon OR @etc-auth (configs, hostname, ssh keys)â”‚
â”‚  â”œâ”€â”€ /var         â†’ @var-anon OR @var-auth (logs, containers, cache)    â”‚
â”‚  â”œâ”€â”€ /home/*/     â†’ Separate home directories                           â”‚
â”‚  â””â”€â”€ /tmp         â†’ tmpfs (volatile, never persisted)                   â”‚
â”‚                                                                          â”‚
â”‚  AUTH's @etc-auth and @var-auth are in INNER LUKS:                      â”‚
â”‚  â””â”€â”€ ANON cannot see AUTH's configs, logs, or container state!          â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Mitigations Applied:**
```bash
# Separate /etc and /var per profile (in fstab)
/dev/mapper/cryptouter  /etc  btrfs  subvol=@etc-anon,noatime  0 0  # ANON
/dev/mapper/cryptinner  /etc  btrfs  subvol=@etc-auth,noatime  0 0  # AUTH (inner LUKS!)

# Mount options (noatime prevents access time leakage)
mount -o noatime,subvol=@root /dev/mapper/cryptouter /

# tmpfs for temp files (never persisted to disk)
tmpfs /tmp tmpfs defaults,noatime,mode=1777,size=2G 0 0
```

---

### Deniability Considerations

**Current design:** Inner LUKS (`auth.luks`) is visible as a file.

```
Can AUTH existence be hidden?
â”œâ”€â”€ auth.luks file â†’ VISIBLE in outer LUKS
â”œâ”€â”€ File size (~80GB) â†’ Clearly not random data
â””â”€â”€ ANON user can see file exists â†’ NOT DENIABLE
```

**Plausible deniability options (NOT implemented):**

| Method | Complexity | Deniability |
|--------|------------|-------------|
| Hidden LUKS header | Medium | Moderate |
| VeraCrypt hidden volume | High | Strong |
| Decoy + hidden OS | Very High | Strongest |

**Current stance:** Deniability not a goal. Focus on:
- Protection from theft (both profiles encrypted)
- Protection of AUTH from ANON access (nested LUKS)
- NOT protection from forensic analysis

---

### Secure Deletion on BTRFS

**Problem:** BTRFS copy-on-write (CoW) means old data may persist.

```bash
# Standard delete does NOT securely erase
rm secret.txt  # Old blocks still on disk!

# Workarounds:
# 1. Encrypt at file level (GPG)
gpg -c secret.txt && rm secret.txt

# 2. Use nodatacow for sensitive files
chattr +C /vault/sensitive/
# Must be set on empty file/dir before writing

# 3. Full subvolume delete + TRIM
btrfs subvolume delete @vault-anon
fstrim -v /mnt/pool

# 4. Re-create LUKS container (nuclear option)
# Regenerate auth.luks with new key
```

**Recommendation:** Sensitive files in vault should use file-level encryption (GPG).

---

### Emergency Scenarios

#### Panic Wipe (Duress)

```bash
# Script: /usr/local/bin/panic-wipe.sh
#!/bin/bash
# WARNING: DESTROYS ALL DATA

# Wipe LUKS headers (makes data irrecoverable)
cryptsetup luksErase /dev/nvme0n1p2 --batch-mode

# Or just wipe first 10MB (faster, destroys header)
dd if=/dev/urandom of=/dev/nvme0n1p2 bs=1M count=10

# Trigger kernel panic to force shutdown
echo c > /proc/sysrq-trigger
```

**Trigger options:**
- Keyboard shortcut (dangerous - accidental trigger)
- Specific boot option in rEFInd
- USB dead man's switch

#### Forgotten Password Recovery

| Scenario | Recovery |
|----------|----------|
| Forgot ANON password | Use AUTH password (unlocks outer) |
| Forgot AUTH password | ANON still works, AUTH data **LOST** |
| Forgot both | All data **LOST** - restore from backup |

**Backup strategy required** (see below).

---

### Backup Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BACKUP ARCHITECTURE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  On-device (BTRFS snapshots):                                           â”‚
â”‚  â”œâ”€â”€ @snapshots/daily/     â† Automatic daily snapshots                  â”‚
â”‚  â”œâ”€â”€ @snapshots/weekly/    â† Weekly retention                           â”‚
â”‚  â””â”€â”€ @snapshots/manual/    â† Before major changes                       â”‚
â”‚                                                                         â”‚
â”‚  Off-device (encrypted):                                                â”‚
â”‚  â”œâ”€â”€ External SSD          â† LUKS-encrypted backup drive                â”‚
â”‚  â”œâ”€â”€ Cloud (rclone)        â† Encrypted before upload                    â”‚
â”‚  â””â”€â”€ Cold storage          â† Paper key backup for LUKS headers          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Snapshot automation:**
```bash
# /etc/systemd/system/btrfs-snapshot.timer
[Timer]
OnCalendar=daily
Persistent=true

# /etc/systemd/system/btrfs-snapshot.service
[Service]
ExecStart=/usr/local/bin/btrfs-snapshot.sh
```

**Off-device backup:**
```bash
# Backup to encrypted external drive
btrfs send /mnt/pool/@snapshots/latest | \
  gpg -c --cipher-algo AES256 | \
  dd of=/dev/sdb1

# Backup LUKS header (CRITICAL - store safely)
cryptsetup luksHeaderBackup /dev/nvme0n1p2 \
  --header-backup-file luks-header-outer.bin
cryptsetup luksHeaderBackup /mnt/pool/auth.luks \
  --header-backup-file luks-header-inner.bin
# Encrypt and store headers separately from data!
```

---

### Browser Profile Isolation

| Browser | ANON Config | AUTH Config |
|---------|-------------|-------------|
| Firefox | Separate profile, Tor mode | Default profile |
| Chromium | Guest mode or container | Normal |

```bash
# Firefox profiles
firefox -P anon  # Hardened, no history
firefox -P auth  # Normal browsing

# Or use Flatpak sandboxing
flatpak run --filesystem=~/.mozilla-anon org.mozilla.firefox
```

---

### Firmware Updates

**Surface Pro requires Windows for firmware updates.**

Options:
1. Boot into Windows partition periodically
2. Use Windows VM (may not work for firmware)
3. Accept risk of outdated firmware

**Recommendation:** Boot Windows monthly for updates.

---

## Threat Model Summary

| Threat | Protected | Method |
|--------|-----------|--------|
| Device theft | âœ“ | Full disk LUKS encryption |
| Border crossing / coercion | Partial | Nested LUKS (AUTH hidden from ANON) |
| Forensic analysis | âœ— | Inner LUKS visible, not deniable |
| Remote compromise | Partial | Profile isolation, minimal attack surface |
| Physical access (cold boot) | Partial | Encrypted swap, shutdown vs suspend |
| Network surveillance | âœ“ (ANON) | Tor, DNSCrypt, MAC randomization |
| Cross-profile leakage | Partial | Separate mounts, volatile logs |

---

## Future Upgrades

- **32GB RAM**: Run multiple VMs simultaneously
- **512GB NVMe**: Larger partitions, more snapshots
- **External GPU**: Passthrough for gaming/ML
- **YubiKey**: Hardware 2FA for AUTH unlock
- **Looking Glass**: Zero-latency Windows VM display
- **VeraCrypt hidden volume**: True deniability if needed
- **Heads/Skulls firmware**: Tamper-evident boot
