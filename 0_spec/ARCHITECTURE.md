# Surface Multi-OS Pool

> **Dual-boot Kinoite + NixOS with full disk encryption and isolated homes**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   ██████╗  ██████╗  ██████╗ ██╗                                            │
│   ██╔══██╗██╔═══██╗██╔═══██╗██║                                            │
│   ██████╔╝██║   ██║██║   ██║██║                                            │
│   ██╔═══╝ ██║   ██║██║   ██║██║                                            │
│   ██║     ╚██████╔╝╚██████╔╝███████╗                                       │
│   ╚═╝      ╚═════╝  ╚═════╝ ╚══════╝                                       │
│                                                                             │
│         KINOITE (bootc)  ════════════════  NIXOS (impermanence)            │
│              mutable /etc/var                  ephemeral /etc/var          │
│                    │                                  │                    │
│                    └──────────┬───────────────────────┘                    │
│                               │                                            │
│                          @shared                                           │
│                    (containers, media, large files)                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

> **Device**: Surface Pro 8 (8GB RAM, 256GB NVMe)
> **OSes**: Fedora Kinoite (Surface kernel) + NixOS (Full Impermanence)
> **Goal**: Isolated dual-boot with shared storage, full disk encryption

---

## Partition Layout

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           NVMe PARTITION LAYOUT                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   nvme0n1p1    100MB    EFI System Partition (FAT32)                       │
│   └── EFI/Boot/bootx64.efi    (GRUB EFI binary only)                       │
│                                                                             │
│   nvme0n1p3    2GB      /boot (ext4) - UNENCRYPTED                         │
│   ├── grub/                   (GRUB config - independent)                  │
│   │   ├── grub.cfg            (auto-generated by script)                   │
│   │   └── themes/                                                          │
│   ├── kinoite/                                                             │
│   │   ├── vmlinuz-kinoite                                                  │
│   │   └── initramfs-kinoite.img                                            │
│   └── nixos/                                                               │
│       ├── kernel                                                           │
│       └── initrd                                                           │
│                                                                             │
│   nvme0n1p4    116GB    LUKS2 Container - ENCRYPTED                        │
│   └── /dev/mapper/pool                                                     │
│       └── BTRFS (label: pool)                                              │
│           ├── @root-kinoite    (Fedora Kinoite system)                     │
│           ├── @root-nixos      (NixOS system + /nix + /persist)            │
│           ├── @home-kinoite    (Kinoite user home - isolated)              │
│           ├── @home-nixos      (NixOS user home - isolated)                │
│           ├── @shared          (common storage for both OSes)              │
│           └── @android         (Waydroid storage)                          │
│                                                                             │
│   nvme0n1p5    118GB    Ubuntu (ext4) - TO BE DELETED                      │
│                         Future: expand LUKS pool                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## BTRFS Subvolume Design

```
BTRFS Pool (inside LUKS):
│
├── @root-kinoite ─────────── Fedora Kinoite Surface
│   │                         bootc + composefs (immutable /usr)
│   ├── /usr                  (immutable, OSTree)
│   ├── /etc                  (mutable, 3-way merge)
│   └── /var                  (mutable, state)
│
├── @root-nixos ───────────── NixOS (Full Impermanence)
│   │                         tmpfs root, generated /etc /var
│   ├── /nix                  → @root-nixos/nix (PERSISTENT)
│   └── /persist              → @root-nixos/persist (PERSISTENT)
│       ├── /etc/machine-id
│       ├── /etc/ssh/ssh_host_*
│       ├── /var/lib/nixos
│       ├── /var/lib/systemd
│       └── /var/lib/bluetooth
│
├── @home-kinoite ─────────── Kinoite User Home (ISOLATED)
│   └── /home/user            dotfiles, configs, projects
│
├── @home-nixos ───────────── NixOS User Home (ISOLATED)
│   └── /home/user            dotfiles, configs, projects
│
├── @shared ───────────────── Common Storage (BOTH OSes)
│   └── /mnt/shared
│       ├── containers/       Docker + Podman images
│       ├── media/            Music, videos, photos
│       ├── downloads/        Large downloads
│       └── vms/              Virtual machine images
│
└── @android ──────────────── Waydroid Storage
    └── /var/lib/waydroid     Android system + apps
```

---

## Immutability Comparison

| Aspect | Kinoite | NixOS |
|--------|---------|-------|
| **Base System** | Immutable /usr (composefs) | Immutable /nix/store |
| **/etc** | Mutable (3-way merge) | Ephemeral (generated) |
| **/var** | Mutable (persistent) | Ephemeral (generated) |
| **Root (/)** | Persistent | tmpfs (2GB RAM) |
| **Config Style** | Imperative (edit files) | Declarative (Nix flake) |
| **Updates** | `bootc upgrade` | `nixos-rebuild switch` |
| **Rollback** | OSTree generations | Nix generations |

### NixOS Impermanence Model

```
┌─────────────────────────────────────────────────────────────────┐
│                    NixOS BOOT SEQUENCE                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. Kernel + initramfs load from /boot/nixos/                 │
│   2. Initramfs prompts for LUKS password                       │
│   3. LUKS unlocked → BTRFS available                           │
│   4. Mount tmpfs as / (empty, 2GB RAM)                         │
│   5. Mount @root-nixos/nix → /nix                              │
│   6. Mount @root-nixos/persist → /persist                      │
│   7. Mount @home-nixos → /home                                 │
│   8. Mount @shared → /mnt/shared                               │
│   9. NixOS activation: generate /etc, /var from /nix/store     │
│  10. Bind mount persistent files from /persist                 │
│  11. Boot complete - pristine OS every time!                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Boot Configuration

### Boot Sequence

```
┌─────────────────────────────────────────────────────────────────┐
│                         BOOT FLOW                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. UEFI loads GRUB from EFI partition (100MB)                │
│                    ↓                                            │
│   2. GRUB displays menu: Kinoite / NixOS                       │
│                    ↓                                            │
│   3. GRUB loads kernel + initramfs from /boot (2GB ext4)       │
│                    ↓                                            │
│   4. Initramfs prompts for LUKS password (1234567890)          │
│                    ↓                                            │
│   5. Initramfs unlocks LUKS, mounts BTRFS subvolume            │
│                    ↓                                            │
│   6. Selected OS boots from encrypted root                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### GRUB Menu

```
┌─────────────────────────────────────────────────────────────────┐
│                      GNU GRUB version 2.12                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   > Fedora Kinoite Surface                                     │
│     NixOS (Impermanence)                                       │
│     UEFI Firmware Settings                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### GRUB Independence

GRUB is managed independently via script, triggered by either OS:

```bash
/boot/grub/update-grub.sh    # Regenerates grub.cfg
```

Both OSes can trigger GRUB update when kernel changes.

---

## Mount Points

### Kinoite Mounts

```bash
/dev/nvme0n1p1                      → /boot/efi
/dev/nvme0n1p3                      → /boot
/dev/mapper/pool @root-kinoite      → /
/dev/mapper/pool @home-kinoite      → /home
/dev/mapper/pool @shared            → /mnt/shared
/dev/mapper/pool @android           → /var/lib/waydroid
```

### NixOS Mounts

```bash
tmpfs                               → /              (2GB, ephemeral)
/dev/nvme0n1p1                      → /boot/efi
/dev/nvme0n1p3                      → /boot
/dev/mapper/pool @root-nixos/nix    → /nix           (persistent)
/dev/mapper/pool @root-nixos/persist → /persist      (persistent)
/dev/mapper/pool @home-nixos        → /home          (persistent)
/dev/mapper/pool @shared            → /mnt/shared    (persistent)
/dev/mapper/pool @android           → /var/lib/waydroid (persistent)
```

---

## NixOS Desktop Configuration

### Desktop Sessions (SDDM)

| Session | Description |
|---------|-------------|
| Plasma (Wayland) | Primary desktop, full featured |
| Plasma (X11) | Fallback for compatibility |
| GNOME | Alternative DE |
| GNOME Kiosk | Locked down mode |
| Openbox | Lightweight WM |
| Waydroid | Android app session |

### Container Runtime

| Engine | Purpose | Storage |
|--------|---------|---------|
| Docker | Compatibility (daemon, root) | @shared/containers/docker |
| Podman | Rootless (primary) | @shared/containers/podman |

---

## Security Model

| Threat | Protection |
|--------|------------|
| Stolen laptop (data theft) | LUKS encrypts all user data |
| Kernel tampering | Secure Boot verifies signatures |
| Boot chain modification | TPM + Secure Boot |
| Cold boot attack | LUKS key in RAM only while running |
| OS compromise (NixOS) | Impermanence wipes on reboot |

### What's Encrypted (LUKS)

- All user data in @home-kinoite and @home-nixos
- All OS files in @root-kinoite and @root-nixos
- All shared data in @shared
- Waydroid data in @android

### What's NOT Encrypted (by design)

- EFI partition (required by UEFI)
- /boot partition (kernel + initramfs)

---

## Default Credentials

| Component | Value |
|-----------|-------|
| **LUKS Password** | `1234567890` |
| **Linux User** | `user` |
| **User Password** | `1234567890` |
| **User UID/GID** | `1000/1000` |
| **Sudo** | `NOPASSWD: ALL` |
| **Groups** | `wheel, docker, podman, video, audio, networkmanager` |

> **Warning**: Change these after deployment!

---

## Key UUIDs

| Component | UUID |
|-----------|------|
| /boot (ext4) | `0eaf7961-48c5-4b55-8a8f-04cd0b71de07` |
| LUKS partition | `3c75c6db-4d7c-4570-81f1-02d168781aac` |
| BTRFS pool | `6818afcb-97f5-43be-9436-4b9c3db98c00` |

---

## Repository Structure

```
/home/diego/mnt_git/unix/
├── 0_spec/
│   ├── ARCHITECTURE.md        (this document)
│   └── ROADMAP.md             (implementation checklist)
│
├── a_kinoite_host/            (Kinoite build)
│   ├── Containerfile          (bootc image definition)
│   ├── build.sh               (build script)
│   └── config/                (overlay configs)
│
├── a_nixos_host/              (NixOS flake)
│   ├── flake.nix              (flake entry point)
│   ├── flake.lock             (dependency lock)
│   ├── configuration.nix      (main config)
│   ├── hardware-configuration.nix
│   └── modules/
│       ├── impermanence.nix   (ephemeral root setup)
│       ├── desktop.nix        (DE configurations)
│       ├── containers.nix     (Docker + Podman)
│       ├── surface.nix        (Surface Pro 8 hardware)
│       └── users.nix          (user configuration)
│
└── a_win11_fallback/          (Windows recovery - optional)
```

---

## NixOS OCI Build Strategy

NixOS is built as an OCI image for faster deployment:

```
┌─────────────────────────────────────────────────────────────────┐
│                    OCI BUILD PIPELINE                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. nix build .#nixosConfigurations.surface.config.system     │
│              .build.ociImage                                    │
│                    ↓                                            │
│   2. podman load < result                                      │
│                    ↓                                            │
│   3. podman create --name nixos-extract <image>                │
│                    ↓                                            │
│   4. podman export nixos-extract | tar -xf - -C @root-nixos    │
│                    ↓                                            │
│   5. Copy kernel + initrd to /boot/nixos/                      │
│                    ↓                                            │
│   6. Update GRUB                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Troubleshooting

### GRUB can't find kernel
- Verify /boot is mounted: `mount | grep boot`
- Check kernel exists: `ls /boot/{kinoite,nixos}/`
- Regenerate GRUB: `/boot/grub/update-grub.sh`

### LUKS won't unlock
- Verify password: `cryptsetup open --test-passphrase /dev/nvme0n1p4`
- Check UUID matches GRUB config

### Wrong subvolume mounted
- Check fstab entries
- Verify subvolume names: `btrfs subvolume list /mnt/pool`

### NixOS boots to empty root
- This is expected (tmpfs root)
- Check /nix is mounted: `mount | grep nix`
- Check /persist is mounted: `mount | grep persist`

---

## Future Plans

- [ ] Delete Ubuntu partition (nvme0n1p5)
- [ ] Expand LUKS pool to use freed space
- [ ] Enable Secure Boot with signed kernels
- [ ] TPM-based LUKS unlock (auto-decrypt)
