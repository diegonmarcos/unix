# Cloud Connect - MINIMUM Profile (Podman)
# Anonymous/clean profile with privacy tools
# Graphics provided by host (Arch VM)
#
# Build: podman build -t cloud-connect:minimum .
# Run: podman-compose up -d

FROM archlinux:latest

LABEL maintainer="Diego Nepomuceno Marcos <me@diegonmarcos.com>"
LABEL description="Minimum profile - anonymous/clean with privacy tools"
LABEL version="2.0"
LABEL profile="minimum"

# ═══════════════════════════════════════════════════════════════════════════
# BASE SYSTEM
# ═══════════════════════════════════════════════════════════════════════════

RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
    # Base
    base-devel \
    git \
    sudo \
    curl \
    wget \
    # Shell
    bash \
    # Core utilities
    coreutils \
    findutils \
    grep \
    sed \
    less \
    htop \
    jq \
    # Network
    iproute2 \
    iputils \
    openssh \
    ca-certificates \
    # Fonts
    ttf-dejavu \
    && pacman -Scc --noconfirm

# ═══════════════════════════════════════════════════════════════════════════
# ADDITIONAL TOOLS (minimum profile)
# ═══════════════════════════════════════════════════════════════════════════

RUN pacman -S --noconfirm \
    # Editor
    vim \
    # Archive
    unzip \
    # Clipboard
    xclip \
    # Screenshot
    scrot \
    # Privacy
    tor \
    torsocks \
    dnscrypt-proxy \
    # Document viewer
    okular \
    && pacman -Scc --noconfirm

# ═══════════════════════════════════════════════════════════════════════════
# LANGUAGES & COMPILERS
# ═══════════════════════════════════════════════════════════════════════════

RUN pacman -S --noconfirm \
    # Node.js
    nodejs \
    npm \
    # Python
    python \
    python-pip \
    python-pipx \
    # Rust
    rust \
    && pacman -Scc --noconfirm

# ═══════════════════════════════════════════════════════════════════════════
# AI CLI TOOLS
# ═══════════════════════════════════════════════════════════════════════════

RUN npm install -g @anthropic-ai/claude-code \
    && npm install -g @google/gemini-cli

# ═══════════════════════════════════════════════════════════════════════════
# GUI APPS (run on host's X server)
# ═══════════════════════════════════════════════════════════════════════════

RUN pacman -S --noconfirm \
    konsole \
    falkon \
    dolphin \
    breeze-icons \
    && pacman -Scc --noconfirm

# ═══════════════════════════════════════════════════════════════════════════
# USER SETUP
# ═══════════════════════════════════════════════════════════════════════════

ARG USERNAME=clouduser
ARG USER_UID=1000
ARG USER_GID=1000

RUN groupadd --gid $USER_GID $USERNAME && \
    useradd --uid $USER_UID --gid $USER_GID -m $USERNAME && \
    echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/$USERNAME && \
    chmod 0440 /etc/sudoers.d/$USERNAME

# ═══════════════════════════════════════════════════════════════════════════
# HOME FOLDER STRUCTURE
# ═══════════════════════════════════════════════════════════════════════════

RUN mkdir -p /home/$USERNAME/{apps,git,mnt,syncs,sys,user,vault} && \
    chown -R $USERNAME:$USERNAME /home/$USERNAME

# ═══════════════════════════════════════════════════════════════════════════
# PRIVACY CONFIG
# ═══════════════════════════════════════════════════════════════════════════

# Configure dnscrypt-proxy
RUN mkdir -p /etc/dnscrypt-proxy && \
    echo "server_names = ['cloudflare', 'cloudflare-ipv6']" > /etc/dnscrypt-proxy/dnscrypt-proxy.toml && \
    echo "listen_addresses = ['127.0.0.1:53']" >> /etc/dnscrypt-proxy/dnscrypt-proxy.toml

# ═══════════════════════════════════════════════════════════════════════════
# ENVIRONMENT
# ═══════════════════════════════════════════════════════════════════════════

ENV CLOUD_IN_CONTAINER=1
ENV CLOUD_PROFILE=minimum
ENV SHELL=/bin/bash

USER $USERNAME
WORKDIR /home/$USERNAME

# ═══════════════════════════════════════════════════════════════════════════
# ENTRYPOINT
# ═══════════════════════════════════════════════════════════════════════════

COPY --chown=$USERNAME:$USERNAME entrypoint.sh /entrypoint.sh
RUN sudo chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash"]
