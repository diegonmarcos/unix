# NixOS Configuration Changes - 2026-01-08

## Summary
Added essential bootstrap tools, home-manager integration, and fixed flatpak configuration.

## Changes Made

### 1. flake.nix
**Added home-manager input:**
```nix
home-manager = {
  url = "github:nix-community/home-manager/release-24.11";
  inputs.nixpkgs.follows = "nixpkgs";
};
```

**Updated outputs to include home-manager module:**
```nix
modules = [
  nixos-hardware.nixosModules.microsoft-surface-pro-intel
  home-manager.nixosModules.home-manager  # NEW
  ./configuration.nix
  ./hardware-configuration.nix
];
```

### 2. configuration.nix

#### Bootstrap Tools Added (Lines 317-322)
```nix
# ─── Bootstrap Tools (CRITICAL - for building user space) ───────────────
firefox      # Web browser (authenticate, download, research)
git          # Version control (clone repos, manage dotfiles)
wget         # Download tool
curl         # Alternative download tool
nodejs       # Includes npm, npx (for Claude Code and JS development)
```

#### Flatpak Flathub Auto-Configuration (Lines 365-374)
```nix
# Add Flathub remote on boot (tmpfs root requires this)
systemd.services.flatpak-add-flathub = {
  description = "Add Flathub remote to Flatpak";
  wantedBy = [ "multi-user.target" ];
  after = [ "network-online.target" ];
  serviceConfig = {
    Type = "oneshot";
    ExecStart = "${pkgs.flatpak}/bin/flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo";
  };
};
```

#### Home Manager Configuration (Lines 146-183)
```nix
home-manager = {
  useGlobalPkgs = true;
  useUserPackages = true;

  users.diego = { pkgs, ... }: {
    home.stateVersion = "24.11";

    home.packages = with pkgs; [
      htop
    ];

    programs.git = {
      enable = true;
      userName = "Diego";
      userEmail = "me@diegonmarcos.com";
    };

    programs.fish = {
      enable = true;
      shellAliases = {
        ll = "ls -lah";
        ".." = "cd ..";
      };
    };
  };

  users.guest = { pkgs, ... }: {
    home.stateVersion = "24.11";
  };
};
```

## What This Fixes

### BEFORE (Broken)
❌ No npm/npx in PATH (claude.sh fails)
❌ No browser to authenticate or download
❌ No git to clone repos
❌ Flatpak has no remotes (can't install apps)
❌ No home-manager for declarative user configs
❌ Bootstrap paradox - can't build your space

### AFTER (Fixed)
✅ npm/npx available (claude.sh works)
✅ Firefox for web browsing
✅ git for version control
✅ wget/curl for downloads
✅ Flatpak with flathub (persists across reboots)
✅ home-manager for managing user dotfiles
✅ Can now build your own environment!

## How to Rebuild

### From Kubuntu (Build new installer)
```bash
cd /mnt/kubuntu/home/diego/mnt_git/unix/a_nixos_host/
./build.sh raw    # Or iso if raw fails
```

### From NixOS (Update running system)
```bash
# Copy config to /etc/nixos if not using flakes
sudo cp /mnt/kubuntu/home/diego/mnt_git/unix/a_nixos_host/configuration.nix /etc/nixos/

# If using flakes (current setup):
cd /mnt/kubuntu/home/diego/mnt_git/unix/a_nixos_host/
sudo nixos-rebuild switch --flake .#surface

# Or build and test in VM first:
nix build .#packages.x86_64-linux.vm
```

## Testing After Rebuild

```bash
# Test 1: Bootstrap tools available
which firefox && which git && which wget && which npm
# All should be found

# Test 2: npm works (no database errors)
npm --version
node --version
npx --version

# Test 3: Claude Code can run
bash ~/user/claude.sh --version
# Should show: 2.1.1 (Claude Code)

# Test 4: Flatpak has flathub
flatpak remotes
# Should show: flathub

# Test 5: Flatpak search works
flatpak search firefox
# Should list packages

# Test 6: Git configured
git config --global user.name
git config --global user.email
# Should show: Diego, me@diegonmarcos.com

# Test 7: Fish aliases
fish
ll
# Should work
```

## Next Steps

After rebuild and reboot:
1. ✅ npm/npx will be in your PATH
2. ✅ Firefox, git, wget available system-wide
3. ✅ Flatpak flathub remote persists across reboots
4. ✅ Run: `bash ~/user/claude.sh` to start Claude Code
5. ✅ Install user-specific packages via home-manager or nix-env
6. ✅ Install GUI apps via flatpak (Steam, Discord, etc.)

## Files Modified
- `/mnt/kubuntu/home/diego/mnt_git/unix/a_nixos_host/flake.nix`
- `/mnt/kubuntu/home/diego/mnt_git/unix/a_nixos_host/configuration.nix`
